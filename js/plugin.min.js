var FIXED_MENU_HEIGHT, DIFF, active_id , $articles;
var article_arr = [];
function anchorFunction($el) {
    var anchor = $el.attr('href');
    anchor = anchor.substring(1);
    var offset = $('#' + anchor).offset();
    var caclculate_offset = offset.top - FIXED_MENU_HEIGHT;
    $("html, body").animate({ scrollTop: caclculate_offset + "px" });
}
function calculateValue() {
    $.each($articles, function (index, el) {
        var offset = $(el).offset();
        var article = new Object();
        article.id = $(el).attr('id')
        article.from = offset.top - FIXED_MENU_HEIGHT - DIFF;
        article.before = $(el).outerHeight(true) + offset.top - FIXED_MENU_HEIGHT - DIFF;
        article_arr[index] = article;
    });
};

function fixScrollTop() {
    $(document).scrollTop($(document).scrollTop() - FIXED_MENU_HEIGHT);
}

function evantMenu() {
    getIdActiveMenu();
    if (active_id != undefined)
        if (!$('[href=#' + active_id + ']').parent().hasClass('active')) {
            console.log(active_id);
            $('.main_menu li').removeClass('active');
            $('[href=#' + active_id + ']').parent().addClass('active');
        }

}

function getIdActiveMenu() {
    for (var article in article_arr) {
        active_id = article_arr[article].id;
        if ($(document).scrollTop() >= article_arr[article].from)
            if ($(document).scrollTop() <= article_arr[article].before)
                return active_id;
    }
}

$.fn.navMenu = function (fan) {
    FIXED_MENU_HEIGHT = $('.main_menu').outerHeight(true);
    DIFF = 1;
    $articles = $(this);

    $(window).resize(function () {
        calculateValue();
    });

    $(window).scroll(function () {
        evantMenu();
    });

    $(window).on('hashchange', function (e) {
        fixScrollTop();
        evantMenu();
    });

    calculateValue();
    evantMenu();
    return this;
};


